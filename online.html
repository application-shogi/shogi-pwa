<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°†æ£‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        .game-area {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .online-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        /* å°†æ£‹ç›¤ã‚¹ã‚¿ã‚¤ãƒ« */
        .shogi-board {
            display: grid;
            grid-template-columns: repeat(9, 40px);
            grid-template-rows: repeat(9, 40px);
            gap: 1px;
            background: #8B4513;
            margin: 20px auto;
            border: 2px solid #654321;
            width: fit-content;
        }
        
        .square {
            width: 40px;
            height: 40px;
            background: #DEB887;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #8B4513;
        }
        
        .square:hover {
            background: #F4E4BC;
        }
        
        .square.selected {
            background: #90EE90 !important;
        }
        
        .square.possible-move {
            background: #FFE4B5 !important;
        }
        
        /* ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .online-panel h3 {
            margin-top: 0;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .game-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .game-info div {
            margin: 5px 0;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* ãƒãƒ£ãƒƒãƒˆ */
        .chat-section {
            border-top: 1px solid #ddd;
            margin-top: 15px;
            padding-top: 15px;
        }
        
        .chat-messages {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .chat-input-group {
            display: flex;
            gap: 5px;
        }
        
        .chat-input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .chat-input-group button {
            padding: 8px 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1001;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .shogi-board {
                grid-template-columns: repeat(9, 35px);
                grid-template-rows: repeat(9, 35px);
            }
            
            .square {
                width: 35px;
                height: 35px;
                font-size: 10px;
            }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <a href="index.html" class="back-button">â† ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
    
    <div class="container">
        <!-- ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
        <div class="game-area">
            <h1>ğŸ¯ å°†æ£‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</h1>
            
            <!-- ã‚²ãƒ¼ãƒ çŠ¶æ…‹è¡¨ç¤º -->
            <div id="game-status" class="status-message status-info">
                Firebaseæ¥ç¶šä¸­...
            </div>
            
            <!-- å°†æ£‹ç›¤ -->
            <div class="shogi-board" id="shogi-board"></div>
            
            <!-- ã‚²ãƒ¼ãƒ æƒ…å ± -->
            <div id="turn-display" style="text-align: center; font-size: 18px; font-weight: bold; margin: 20px 0;">
                ç¾åœ¨ã®æ‰‹ç•ª: å…ˆæ‰‹
            </div>
        </div>
        
        <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ãƒ‘ãƒãƒ« -->
        <div class="online-panel">
            <h3>ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</h3>
            
            <!-- Firebaseæ¥ç¶šçŠ¶æ…‹ -->
            <div id="firebase-status" class="debug-info">
                Firebase: æ¥ç¶šä¸­...
            </div>
            
            <!-- å‚åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="join-form">
                <div class="form-group">
                    <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
                    <input type="text" id="player-name" placeholder="ã‚ãªãŸã®åå‰" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1">
                </div>
                
                <div class="form-group">
                    <label>ãƒ«ãƒ¼ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="text" id="room-password" placeholder="å‹é”ã¨æ±ºã‚ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" value="test123">
                </div>
                
                <button class="btn btn-primary" id="join-room-btn" disabled>éƒ¨å±‹ã«å‚åŠ ï¼ˆFirebaseæ¥ç¶šä¸­...ï¼‰</button>
                
                <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                    ğŸ’¡ å‹é”ã¨åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨å¯¾æˆ¦ã§ãã¾ã™
                </div>
            </div>
            
            <!-- ã‚²ãƒ¼ãƒ æƒ…å ±ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ï¼‰ -->
            <div id="game-info" class="game-info hidden">
                <div><strong>éƒ¨å±‹:</strong> <span id="current-room">-</span></div>
                <div><strong>ã‚ãªãŸ:</strong> <span id="your-side">-</span></div>
                <div><strong>ç›¸æ‰‹:</strong> <span id="opponent-name">å¾…æ©Ÿä¸­...</span></div>
                <div><strong>æ‰‹ç•ª:</strong> <span id="current-turn-online">-</span></div>
            </div>
            
            <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ“ä½œãƒœã‚¿ãƒ³ -->
            <div id="online-controls" class="hidden">
                <button class="btn btn-danger" id="resign-btn">æŠ•äº†</button>
                <button class="btn btn-warning" id="leave-room-btn">éƒ¨å±‹ã‚’å‡ºã‚‹</button>
            </div>
            
            <!-- ãƒãƒ£ãƒƒãƒˆ -->
            <div id="chat-section" class="chat-section hidden">
                <h4>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h4>
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input-group">
                    <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                    <button id="send-chat-btn">é€ä¿¡</button>
                </div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="status-messages"></div>
        </div>
    </div>

    <!-- Firebase SDK - CSPå¯¾å¿œç‰ˆ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebaseè¨­å®š - compatç‰ˆã‚’ä½¿ç”¨
        const firebaseConfig = {
            apiKey: "AIzaSyBj58MkqswywncKrifsD5RyG68CuqkGQKQ",
            authDomain: "my-shogi-online.firebaseapp.com",
            projectId: "my-shogi-online",
            storageBucket: "my-shogi-online.firebasestorage.app",
            messagingSenderId: "233156650037",
            appId: "1:233156650037:web:14802f4bffe4122a39bd7c",
            measurementId: "G-YLTBF91J1T"
        };

        // FirebaseåˆæœŸåŒ–
        let app, db;
        let isFirebaseReady = false;

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseReady = true;
            updateFirebaseStatus('Firebaseæ¥ç¶šæˆåŠŸ');
            
            // æ¥ç¶šãƒ†ã‚¹ãƒˆ
            testFirebaseConnection();
            
        } catch (error) {
            console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            updateFirebaseStatus('FirebaseåˆæœŸåŒ–å¤±æ•—: ' + error.message);
        }
        
        function updateFirebaseStatus(message) {
            const statusElement = document.getElementById('firebase-status');
            if (statusElement) {
                statusElement.textContent = 'Firebase: ' + message;
            }
            console.log('Firebase Status:', message);
        }
        
        // Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testFirebaseConnection() {
            try {
                await db.collection('test').doc('connection_test').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    message: 'connection test'
                });
                
                updateFirebaseStatus('Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ');
                enableJoinButton();
                updateGameStatus('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ï¼‰');
                
            } catch (error) {
                console.error('Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                updateFirebaseStatus('Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error.message);
                
                if (error.code === 'permission-denied') {
                    updateFirebaseStatus('ã‚¨ãƒ©ãƒ¼: Firebaseã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®è¨­å®šãŒå¿…è¦ã§ã™');
                    showStatus('Firebaseã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
                }
            }
        }
        
        function enableJoinButton() {
            const joinBtn = document.getElementById('join-room-btn');
            if (joinBtn) {
                joinBtn.disabled = false;
                joinBtn.textContent = 'éƒ¨å±‹ã«å‚åŠ ';
            }
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ•°
        let board = [];
        let currentPlayer = 'sente';
        let selectedSquare = null;
        let gameMode = 'offline';
        
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        const onlineGame = {
            isOnline: false,
            roomPassword: null,
            playerId: 'player_' + Math.random().toString(36).substr(2, 9),
            playerName: null,
            playerSide: null,
            gameListener: null
        };

        // é§’ã®å®šç¾©
        const pieces = {
            'K': 'ç‹', 'R': 'é£›', 'B': 'è§’', 'G': 'é‡‘', 'S': 'éŠ€', 'N': 'æ¡‚', 'L': 'é¦™', 'P': 'æ­©',
            'k': 'ç‰', 'r': 'é¾', 'b': 'é¦¬', 'g': 'é‡‘', 's': 'éŠ€', 'n': 'æ¡‚', 'l': 'é¦™', 'p': 'æ­©'
        };

        // ç›¤é¢åˆæœŸåŒ–
        function initializeBoard() {
            console.log('ç›¤é¢åˆæœŸåŒ–é–‹å§‹');
            
            try {
                board = Array(9).fill().map(() => Array(9).fill(null));
                
                // å¾Œæ‰‹ã®é§’é…ç½®
                board[0] = ['l', 'n', 's', 'g', 'k', 'g', 's', 'n', 'l'];
                board[1] = [null, 'r', null, null, null, null, null, 'b', null];
                board[2] = ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'];
                
                // å…ˆæ‰‹ã®é§’é…ç½®
                board[6] = ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'];
                board[7] = [null, 'B', null, null, null, null, null, 'R', null];
                board[8] = ['L', 'N', 'S', 'G', 'K', 'G', 'S', 'N', 'L'];
                
                renderBoard();
                console.log('ç›¤é¢åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('ç›¤é¢åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ç›¤é¢åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ç›¤é¢æç”»
        function renderBoard() {
            const boardElement = document.getElementById('shogi-board');
            if (!boardElement) {
                console.error('å°†æ£‹ç›¤è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            boardElement.innerHTML = '';
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const square = document.createElement('div');
                    square.className = 'square';
                    square.dataset.row = row;
                    square.dataset.col = col;
                    
                    const piece = board[row][col];
                    if (piece) {
                        square.textContent = pieces[piece] || piece;
                        square.style.color = piece === piece.toUpperCase() ? '#8B0000' : '#000080';
                    }
                    
                    square.addEventListener('click', function() {
                        handleSquareClick(row, col);
                    });
                    
                    boardElement.appendChild(square);
                }
            }
        }

        // ãƒã‚¹ç›®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleSquareClick(row, col) {
            if (gameMode === 'online' && onlineGame.isOnline) {
                if (!isMyTurn()) {
                    showStatus('ç›¸æ‰‹ã®æ‰‹ç•ªã§ã™', 'error');
                    return;
                }
            }

            if (selectedSquare === null) {
                if (board[row][col] && canSelectPiece(board[row][col])) {
                    selectedSquare = { row: row, col: col };
                    highlightSquare(row, col, 'selected');
                    showPossibleMoves(row, col);
                }
            } else {
                const fromRow = selectedSquare.row;
                const fromCol = selectedSquare.col;
                
                if (fromRow === row && fromCol === col) {
                    clearHighlights();
                    selectedSquare = null;
                } else if (canMovePiece(fromRow, fromCol, row, col)) {
                    makeMove(fromRow, fromCol, row, col);
                } else {
                    clearHighlights();
                    selectedSquare = null;
                    if (board[row][col] && canSelectPiece(board[row][col])) {
                        selectedSquare = { row: row, col: col };
                        highlightSquare(row, col, 'selected');
                        showPossibleMoves(row, col);
                    }
                }
            }
        }

        function canSelectPiece(piece) {
            if (currentPlayer === 'sente') {
                return piece === piece.toUpperCase();
            } else {
                return piece === piece.toLowerCase();
            }
        }

        function canMovePiece(fromRow, fromCol, toRow, toCol) {
            if (toRow < 0 || toRow >= 9 || toCol < 0 || toCol >= 9) return false;
            const targetPiece = board[toRow][toCol];
            if (targetPiece && canSelectPiece(targetPiece)) return false;
            return true;
        }

        function makeMove(fromRow, fromCol, toRow, toCol) {
            const piece = board[fromRow][fromCol];
            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = null;
            
            clearHighlights();
            selectedSquare = null;
            
            currentPlayer = currentPlayer === 'sente' ? 'gote' : 'sente';
            updateTurnDisplay();
            
            if (gameMode === 'online' && onlineGame.isOnline) {
                sendMoveToOpponent(fromRow, fromCol, toRow, toCol);
            }
            
            renderBoard();
        }

        function highlightSquare(row, col, className) {
            const square = document.querySelector('[data-row="' + row + '"][data-col="' + col + '"]');
            if (square) {
                square.classList.add(className);
            }
        }

        function showPossibleMoves(row, col) {
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    const newRow = row + dr;
                    const newCol = col + dc;
                    if (newRow >= 0 && newRow < 9 && newCol >= 0 && newCol < 9) {
                        if (canMovePiece(row, col, newRow, newCol)) {
                            highlightSquare(newRow, newCol, 'possible-move');
                        }
                    }
                }
            }
        }

        function clearHighlights() {
            const squares = document.querySelectorAll('.square');
            for (let i = 0; i < squares.length; i++) {
                squares[i].classList.remove('selected', 'possible-move');
            }
        }

        function updateTurnDisplay() {
            const turnText = currentPlayer === 'sente' ? 'å…ˆæ‰‹' : 'å¾Œæ‰‹';
            const element = document.getElementById('turn-display');
            if (element) {
                element.textContent = 'ç¾åœ¨ã®æ‰‹ç•ª: ' + turnText;
            }
        }

        function updateGameStatus(message) {
            const element = document.getElementById('game-status');
            if (element) {
                element.textContent = message;
            }
        }

        function isMyTurn() {
            if (!onlineGame.isOnline) return true;
            return (currentPlayer === 'sente' && onlineGame.playerSide === 'sente') ||
                   (currentPlayer === 'gote' && onlineGame.playerSide === 'gote');
        }

        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½
        async function joinRoom() {
            const playerName = document.getElementById('player-name').value.trim();
            const password = document.getElementById('room-password').value.trim();
            
            if (!playerName || !password) {
                showStatus('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!isFirebaseReady) {
                showStatus('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                showStatus('éƒ¨å±‹ã«å‚åŠ ä¸­...', 'info');
                
                onlineGame.roomPassword = password;
                onlineGame.playerName = playerName;
                
                const roomRef = db.collection('rooms').doc(password);
                const roomDoc = await roomRef.get();
                
                if (!roomDoc.exists) {
                    await createRoom(password, playerName);
                } else {
                    await joinExistingRoom(roomDoc.data(), playerName);
                }
                
                listenToRoom();
                
            } catch (error) {
                console.error('éƒ¨å±‹å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message, 'error');
                
                if (error.code === 'permission-denied') {
                    showStatus('Firebaseã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                }
            }
        }

        async function createRoom(password, playerName) {
            onlineGame.playerSide = 'sente';
            
            const roomData = {
                password: password,
                players: {
                    sente: {
                        id: onlineGame.playerId,
                        name: playerName,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    gote: null
                },
                board: boardToSfen(),
                currentTurn: 'sente',
                moves: [],
                gameStatus: 'waiting',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                chat: []
            };

            await db.collection('rooms').doc(password).set(roomData);
            showGameInfo({ side: 'sente', message: 'éƒ¨å±‹ã€Œ' + password + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...' });
        }

        async function joinExistingRoom(roomData, playerName) {
            if (roomData.players.gote !== null) {
                // éƒ¨å±‹ãŒæº€å“¡ã®å ´åˆã€å¤ã„éƒ¨å±‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ãä½œæˆ
                console.log('éƒ¨å±‹ãŒæº€å“¡ã®ãŸã‚ã€æ–°ã—ã„éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã™');
                await createRoom(onlineGame.roomPassword, playerName);
                return;
            }
            
            onlineGame.playerSide = 'gote';
            
            await db.collection('rooms').doc(onlineGame.roomPassword).update({
                'players.gote': {
                    id: onlineGame.playerId,
                    name: playerName,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                gameStatus: 'playing',
                gameStartedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            showGameInfo({ 
                side: 'gote', 
                message: 'éƒ¨å±‹ã€Œ' + onlineGame.roomPassword + 'ã€ã«å‚åŠ ã—ã¾ã—ãŸã€‚ã‚²ãƒ¼ãƒ é–‹å§‹ï¼',
                opponent: roomData.players.sente.name 
            });
        }

        function listenToRoom() {
            onlineGame.gameListener = db.collection('rooms').doc(onlineGame.roomPassword)
                .onSnapshot(function(doc) {
                    if (doc.exists) {
                        const roomData = doc.data();
                        handleRoomUpdate(roomData);
                    } else {
                        showStatus('éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                }, function(error) {
                    console.error('éƒ¨å±‹ç›£è¦–ã‚¨ãƒ©ãƒ¼:', error);
                    showStatus('éƒ¨å±‹ã®ç›£è¦–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                });

            onlineGame.isOnline = true;
            gameMode = 'online';
        }

        function handleRoomUpdate(roomData) {
            if (roomData.gameStatus === 'playing' && roomData.players.gote && onlineGame.playerSide === 'sente') {
                document.getElementById('opponent-name').textContent = roomData.players.gote.name;
                showStatus('ç›¸æ‰‹ãŒå‚åŠ ã—ã¾ã—ãŸã€‚ã‚²ãƒ¼ãƒ é–‹å§‹ï¼', 'success');
            }

            if (roomData.board) {
                sfenToBoard(roomData.board);
            }

            currentPlayer = roomData.currentTurn;
            updateTurnDisplay();
            updateOnlineTurnDisplay(roomData.currentTurn);

            if (roomData.chat && roomData.chat.length > 0) {
                const lastMessage = roomData.chat[roomData.chat.length - 1];
                if (lastMessage.timestamp) {
                    addChatMessage(lastMessage);
                }
            }

            updateOnlineGameStatus(roomData.gameStatus);
        }

        async function sendMoveToOpponent(fromRow, fromCol, toRow, toCol) {
            try {
                const move = {
                    from: { row: fromRow, col: fromCol },
                    to: { row: toRow, col: toCol },
                    player: onlineGame.playerSide,
                    timestamp: Date.now() // serverTimestamp() ã¯arrayUnionå†…ã§ã¯ä½¿ç”¨ä¸å¯
                };

                await db.collection('rooms').doc(onlineGame.roomPassword).update({
                    moves: firebase.firestore.FieldValue.arrayUnion(move),
                    currentTurn: currentPlayer,
                    board: boardToSfen(),
                    lastMoveAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('æŒ‡ã—æ‰‹é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('æŒ‡ã—æ‰‹ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        function boardToSfen() {
            return JSON.stringify(board);
        }

        function sfenToBoard(sfen) {
            try {
                const newBoard = JSON.parse(sfen);
                if (JSON.stringify(newBoard) !== JSON.stringify(board)) {
                    board = newBoard;
                    renderBoard();
                }
            } catch (error) {
                console.error('ç›¤é¢å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || !onlineGame.isOnline) return;

            try {
                const chatMessage = {
                    player: onlineGame.playerSide,
                    playerName: onlineGame.playerName,
                    message: message,
                    timestamp: Date.now() // serverTimestamp() ã¯arrayUnionå†…ã§ã¯ä½¿ç”¨ä¸å¯
                };

                await db.collection('rooms').doc(onlineGame.roomPassword).update({
                    chat: firebase.firestore.FieldValue.arrayUnion(chatMessage)
                });

                input.value = '';
                
            } catch (error) {
                console.error('ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        async function resign() {
            if (!onlineGame.isOnline) return;
            
            if (confirm('æœ¬å½“ã«æŠ•äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    const winner = onlineGame.playerSide === 'sente' ? 'gote' : 'sente';
                    
                    await db.collection('rooms').doc(onlineGame.roomPassword).update({
                        gameStatus: 'finished',
                        result: {
                            winner: winner,
                            loser: onlineGame.playerSide,
                            reason: 'resignation',
                            finishedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    showStatus('æŠ•äº†ã—ã¾ã—ãŸ', 'info');
                    
                } catch (error) {
                    console.error('æŠ•äº†ã‚¨ãƒ©ãƒ¼:', error);
                    showStatus('æŠ•äº†ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }
        }

        function leaveRoom() {
            if (onlineGame.gameListener) {
                onlineGame.gameListener();
                onlineGame.gameListener = null;
            }
            
            onlineGame.isOnline = false;
            gameMode = 'offline';
            
            document.getElementById('join-form').classList.remove('hidden');
            document.getElementById('game-info').classList.add('hidden');
            document.getElementById('online-controls').classList.add('hidden');
            document.getElementById('chat-section').classList.add('hidden');
            
            updateGameStatus('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ï¼‰');
            showStatus('éƒ¨å±‹ã‚’å‡ºã¾ã—ãŸ', 'info');
        }

        // UIé–¢æ•°
        function showGameInfo(data) {
            document.getElementById('join-form').classList.add('hidden');
            document.getElementById('game-info').classList.remove('hidden');
            document.getElementById('online-controls').classList.remove('hidden');
            document.getElementById('chat-section').classList.remove('hidden');
            
            document.getElementById('current-room').textContent = onlineGame.roomPassword;
            document.getElementById('your-side').textContent = data.side === 'sente' ? 'å…ˆæ‰‹' : 'å¾Œæ‰‹';
            
            if (data.opponent) {
                document.getElementById('opponent-name').textContent = data.opponent;
            }
            
            showStatus(data.message, 'success');
        }

        function updateOnlineTurnDisplay(turn) {
            const element = document.getElementById('current-turn-online');
            if (element) {
                element.textContent = turn === 'sente' ? 'å…ˆæ‰‹' : 'å¾Œæ‰‹';
            }
        }

        function updateOnlineGameStatus(status) {
            if (status === 'playing') {
                updateGameStatus('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ä¸­');
            } else if (status === 'waiting') {
                updateGameStatus('ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™...');
            }
        }

        function addChatMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const existingMessages = chatMessages.querySelectorAll('div');
            const messageText = message.playerName + ': ' + message.message;
            for (let i = 0; i < existingMessages.length; i++) {
                if (existingMessages[i].textContent.includes(messageText)) {
                    return; // æ—¢ã«è¡¨ç¤ºæ¸ˆã¿
                }
            }
            
            const messageDiv = document.createElement('div');
            // timestampãŒnumberã®å ´åˆã¨Firestoreã®Timestampã®å ´åˆã«å¯¾å¿œ
            const timestamp = message.timestamp;
            let time;
            if (typeof timestamp === 'number') {
                time = new Date(timestamp).toLocaleTimeString();
            } else if (timestamp && timestamp.toDate) {
                time = timestamp.toDate().toLocaleTimeString();
            } else {
                time = new Date().toLocaleTimeString();
            }
            
            messageDiv.innerHTML = 
                '<span style="color: #666; font-size: 10px;">' + time + '</span> ' +
                '<strong style="color: ' + (message.player === 'sente' ? '#8B0000' : '#000080') + ';">' +
                message.playerName + ':</strong> ' +
                message.message;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = 'status-message status-' + type;
            messageDiv.textContent = message;
            
            statusDiv.appendChild(messageDiv);
            
            setTimeout(function() {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // ç›¤é¢åˆæœŸåŒ–
            initializeBoard();
            updateTurnDisplay();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('join-room-btn').addEventListener('click', joinRoom);
            document.getElementById('resign-btn').addEventListener('click', resign);
            document.getElementById('leave-room-btn').addEventListener('click', leaveRoom);
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            
            document.getElementById('chat-input').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    sendChatMessage();
                }
            });
        });

    </script>
</body>
</html>
