<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>将棋オンライン対戦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        .game-area {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .online-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        /* 将棋盤スタイル */
        .shogi-board {
            display: grid;
            grid-template-columns: repeat(9, 40px);
            grid-template-rows: repeat(9, 40px);
            gap: 1px;
            background: #8B4513;
            margin: 20px auto;
            border: 2px solid #654321;
            width: fit-content;
        }
        
        .square {
            width: 40px;
            height: 40px;
            background: #DEB887;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #8B4513;
        }
        
        .square:hover {
            background: #F4E4BC;
        }
        
        .square.selected {
            background: #90EE90 !important;
        }
        
        .square.possible-move {
            background: #FFE4B5 !important;
        }
        
        /* オンライン機能のスタイル */
        .online-panel h3 {
            margin-top: 0;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .game-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .game-info div {
            margin: 5px 0;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* チャット */
        .chat-section {
            border-top: 1px solid #ddd;
            margin-top: 15px;
            padding-top: 15px;
        }
        
        .chat-messages {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .chat-input-group {
            display: flex;
            gap: 5px;
        }
        
        .chat-input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .chat-input-group button {
            padding: 8px 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* デバッグ情報 */
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        /* 戻るボタン */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1001;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        
        /* レスポンシブ */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .shogi-board {
                grid-template-columns: repeat(9, 35px);
                grid-template-rows: repeat(9, 35px);
            }
            
            .square {
                width: 35px;
                height: 35px;
                font-size: 10px;
            }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 戻るボタン -->
    <a href="index.html" class="back-button">← メインページに戻る</a>
    
    <div class="container">
        <!-- ゲームエリア -->
        <div class="game-area">
            <h1>🏯 将棋オンライン対戦</h1>
            
            <!-- ゲーム状態表示 -->
            <div id="game-status" class="status-message status-info">
                Firebase接続中...
            </div>
            
            <!-- 将棋盤 -->
            <div class="shogi-board" id="shogi-board"></div>
            
            <!-- ゲーム情報 -->
            <div id="turn-display" style="text-align: center; font-size: 18px; font-weight: bold; margin: 20px 0;">
                現在の手番: 先手
            </div>
        </div>
        
        <!-- オンライン機能パネル -->
        <div class="online-panel">
            <h3>🌐 オンライン対戦</h3>
            
            <!-- Firebase接続状態 -->
            <div id="firebase-status" class="debug-info">
                Firebase: 接続中...
            </div>
            
            <!-- 参加フォーム -->
            <div id="join-form">
                <div class="form-group">
                    <label>プレイヤー名</label>
                    <input type="text" id="player-name" placeholder="あなたの名前" value="プレイヤー1">
                </div>
                
                <div class="form-group">
                    <label>ルームパスワード</label>
                    <input type="text" id="room-password" placeholder="友達と決めたパスワード" value="test123">
                </div>
                
                <button class="btn btn-primary" id="join-room-btn" disabled>部屋に参加（Firebase接続中...）</button>
                
                <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                    💡 友達と同じパスワードを入力すると対戦できます
                </div>
            </div>
            
            <!-- ゲーム情報（オンライン時） -->
            <div id="game-info" class="game-info hidden">
                <div><strong>部屋:</strong> <span id="current-room">-</span></div>
                <div><strong>あなた:</strong> <span id="your-side">-</span></div>
                <div><strong>相手:</strong> <span id="opponent-name">待機中...</span></div>
                <div><strong>手番:</strong> <span id="current-turn-online">-</span></div>
            </div>
            
            <!-- オンライン操作ボタン -->
            <div id="online-controls" class="hidden">
                <button class="btn btn-danger" id="resign-btn">投了</button>
                <button class="btn btn-warning" id="leave-room-btn">部屋を出る</button>
            </div>
            
            <!-- チャット -->
            <div id="chat-section" class="chat-section hidden">
                <h4>💬 チャット</h4>
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input-group">
                    <input type="text" id="chat-input" placeholder="メッセージを入力...">
                    <button id="send-chat-btn">送信</button>
                </div>
            </div>
            
            <!-- ステータスメッセージ -->
            <div id="status-messages"></div>
        </div>
    </div>

    <!-- Firebase SDK - CSP対応版 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase設定 - compat版を使用
        const firebaseConfig = {
            apiKey: "AIzaSyBj58MkqswywncKrifsD5RyG68CuqkGQKQ",
            authDomain: "my-shogi-online.firebaseapp.com",
            projectId: "my-shogi-online",
            storageBucket: "my-shogi-online.firebasestorage.app",
            messagingSenderId: "233156650037",
            appId: "1:233156650037:web:14802f4bffe4122a39bd7c",
            measurementId: "G-YLTBF91J1T"
        };

        // Firebase初期化
        let app, db;
        let isFirebaseReady = false;

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseReady = true;
            updateFirebaseStatus('Firebase接続成功');
            
            // 接続テスト
            testFirebaseConnection();
            
        } catch (error) {
            console.error('Firebase初期化エラー:', error);
            updateFirebaseStatus('Firebase初期化失敗: ' + error.message);
        }
        
        function updateFirebaseStatus(message) {
            const statusElement = document.getElementById('firebase-status');
            if (statusElement) {
                statusElement.textContent = 'Firebase: ' + message;
            }
            console.log('Firebase Status:', message);
        }
        
        // Firebase接続テスト
        async function testFirebaseConnection() {
            try {
                await db.collection('test').doc('connection_test').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    message: 'connection test'
                });
                
                updateFirebaseStatus('Firebase接続テスト成功');
                enableJoinButton();
                updateGameStatus('オフライン（ローカル対戦モード）');
                
            } catch (error) {
                console.error('Firebase接続テストエラー:', error);
                updateFirebaseStatus('Firebase接続テスト失敗: ' + error.message);
                
                if (error.code === 'permission-denied') {
                    updateFirebaseStatus('エラー: Firebaseセキュリティルールの設定が必要です');
                    showStatus('Firebaseのセキュリティルールを設定してください', 'error');
                }
            }
        }
        
        function enableJoinButton() {
            const joinBtn = document.getElementById('join-room-btn');
            if (joinBtn) {
                joinBtn.disabled = false;
                joinBtn.textContent = '部屋に参加';
            }
        }

        // ゲーム状態変数
        let board = [];
        let currentPlayer = 'sente';
        let selectedSquare = null;
        let gameMode = 'offline';
        
        // オンラインゲーム状態
        const onlineGame = {
            isOnline: false,
            roomPassword: null,
            playerId: 'player_' + Math.random().toString(36).substr(2, 9),
            playerName: null,
            playerSide: null,
            gameListener: null
        };

        // 駒の定義
        const pieces = {
            'K': '王', 'R': '飛', 'B': '角', 'G': '金', 'S': '銀', 'N': '桂', 'L': '香', 'P': '歩',
            'k': '玉', 'r': '龍', 'b': '馬', 'g': '金', 's': '銀', 'n': '桂', 'l': '香', 'p': '歩'
        };

        // 盤面初期化
        function initializeBoard() {
            console.log('盤面初期化開始');
            
            try {
                board = Array(9).fill().map(() => Array(9).fill(null));
                
                // 後手の駒配置
                board[0] = ['l', 'n', 's', 'g', 'k', 'g', 's', 'n', 'l'];
                board[1] = [null, 'r', null, null, null, null, null, 'b', null];
                board[2] = ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'];
                
                // 先手の駒配置
                board[6] = ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'];
                board[7] = [null, 'B', null, null, null, null, null, 'R', null];
                board[8] = ['L', 'N', 'S', 'G', 'K', 'G', 'S', 'N', 'L'];
                
                renderBoard();
                console.log('盤面初期化完了');
                
            } catch (error) {
                console.error('盤面初期化エラー:', error);
                showStatus('盤面初期化エラー: ' + error.message, 'error');
            }
        }

        // 盤面描画
        function renderBoard() {
            const boardElement = document.getElementById('shogi-board');
            if (!boardElement) {
                console.error('将棋盤要素が見つかりません');
                return;
            }
            
            boardElement.innerHTML = '';
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const square = document.createElement('div');
                    square.className = 'square';
                    square.dataset.row = row;
                    square.dataset.col = col;
                    
                    const piece = board[row][col];
                    if (piece) {
                        square.textContent = pieces[piece] || piece;
                        square.style.color = piece === piece.toUpperCase() ? '#8B0000' : '#000080';
                    }
                    
                    square.addEventListener('click', function() {
                        handleSquareClick(row, col);
                    });
                    
                    boardElement.appendChild(square);
                }
            }
        }

        // マス目クリック処理
        function handleSquareClick(row, col) {
            if (gameMode === 'online' && onlineGame.isOnline) {
                if (!isMyTurn()) {
                    showStatus('相手の手番です', 'error');
                    return;
                }
            }

            if (selectedSquare === null) {
                if (board[row][col] && canSelectPiece(board[row][col])) {
                    selectedSquare = { row: row, col: col };
                    highlightSquare(row, col, 'selected');
                    showPossibleMoves(row, col);
                }
            } else {
                const fromRow = selectedSquare.row;
                const fromCol = selectedSquare.col;
                
                if (fromRow === row && fromCol === col) {
                    clearHighlights();
                    selectedSquare = null;
                } else if (canMovePiece(fromRow, fromCol, row, col)) {
                    makeMove(fromRow, fromCol, row, col);
                } else {
                    clearHighlights();
                    selectedSquare = null;
                    if (board[row][col] && canSelectPiece(board[row][col])) {
                        selectedSquare = { row: row, col: col };
                        highlightSquare(row, col, 'selected');
                        showPossibleMoves(row, col);
                    }
                }
            }
        }

        function canSelectPiece(piece) {
            if (currentPlayer === 'sente') {
                return piece === piece.toUpperCase();
            } else {
                return piece === piece.toLowerCase();
            }
        }

        function canMovePiece(fromRow, fromCol, toRow, toCol) {
            if (toRow < 0 || toRow >= 9 || toCol < 0 || toCol >= 9) return false;
            const targetPiece = board[toRow][toCol];
            if (targetPiece && canSelectPiece(targetPiece)) return false;
            return true;
        }

        function makeMove(fromRow, fromCol, toRow, toCol) {
            const piece = board[fromRow][fromCol];
            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = null;
            
            clearHighlights();
            selectedSquare = null;
            
            currentPlayer = currentPlayer === 'sente' ? 'gote' : 'sente';
            updateTurnDisplay();
            
            if (gameMode === 'online' && onlineGame.isOnline) {
                sendMoveToOpponent(fromRow, fromCol, toRow, toCol);
            }
            
            renderBoard();
        }

        function highlightSquare(row, col, className) {
            const square = document.querySelector('[data-row="' + row + '"][data-col="' + col + '"]');
            if (square) {
                square.classList.add(className);
            }
        }

        function showPossibleMoves(row, col) {
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    const newRow = row + dr;
                    const newCol = col + dc;
                    if (newRow >= 0 && newRow < 9 && newCol >= 0 && newCol < 9) {
                        if (canMovePiece(row, col, newRow, newCol)) {
                            highlightSquare(newRow, newCol, 'possible-move');
                        }
                    }
                }
            }
        }

        function clearHighlights() {
            const squares = document.querySelectorAll('.square');
            for (let i = 0; i < squares.length; i++) {
                squares[i].classList.remove('selected', 'possible-move');
            }
        }

        function updateTurnDisplay() {
            const turnText = currentPlayer === 'sente' ? '先手' : '後手';
            const element = document.getElementById('turn-display');
            if (element) {
                element.textContent = '現在の手番: ' + turnText;
            }
        }

        function updateGameStatus(message) {
            const element = document.getElementById('game-status');
            if (element) {
                element.textContent = message;
            }
        }

        function isMyTurn() {
            if (!onlineGame.isOnline) return true;
            return (currentPlayer === 'sente' && onlineGame.playerSide === 'sente') ||
                   (currentPlayer === 'gote' && onlineGame.playerSide === 'gote');
        }

        // オンライン機能
        async function joinRoom() {
            const playerName = document.getElementById('player-name').value.trim();
            const password = document.getElementById('room-password').value.trim();
            
            if (!playerName || !password) {
                showStatus('プレイヤー名とパスワードを入力してください', 'error');
                return;
            }
            
            if (!isFirebaseReady) {
                showStatus('Firebaseが初期化されていません', 'error');
                return;
            }
            
            try {
                showStatus('部屋に参加中...', 'info');
                
                onlineGame.roomPassword = password;
                onlineGame.playerName = playerName;
                
                const roomRef = db.collection('rooms').doc(password);
                const roomDoc = await roomRef.get();
                
                if (!roomDoc.exists) {
                    await createRoom(password, playerName);
                } else {
                    await joinExistingRoom(roomDoc.data(), playerName);
                }
                
                listenToRoom();
                
            } catch (error) {
                console.error('部屋参加エラー:', error);
                showStatus('ルームに参加できませんでした: ' + error.message, 'error');
                
                if (error.code === 'permission-denied') {
                    showStatus('Firebaseのセキュリティルールを確認してください', 'error');
                }
            }
        }

        async function createRoom(password, playerName) {
            onlineGame.playerSide = 'sente';
            
            const roomData = {
                password: password,
                players: {
                    sente: {
                        id: onlineGame.playerId,
                        name: playerName,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    gote: null
                },
                board: boardToSfen(),
                currentTurn: 'sente',
                moves: [],
                gameStatus: 'waiting',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                chat: []
            };

            await db.collection('rooms').doc(password).set(roomData);
            showGameInfo({ side: 'sente', message: '部屋「' + password + '」を作成しました。相手を待っています...' });
        }

        async function joinExistingRoom(roomData, playerName) {
            if (roomData.players.gote !== null) {
                // 部屋が満員の場合、古い部屋をリセットして新しく作成
                console.log('部屋が満員のため、新しい部屋を作成します');
                await createRoom(onlineGame.roomPassword, playerName);
                return;
            }
            
            onlineGame.playerSide = 'gote';
            
            await db.collection('rooms').doc(onlineGame.roomPassword).update({
                'players.gote': {
                    id: onlineGame.playerId,
                    name: playerName,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                gameStatus: 'playing',
                gameStartedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            showGameInfo({ 
                side: 'gote', 
                message: '部屋「' + onlineGame.roomPassword + '」に参加しました。ゲーム開始！',
                opponent: roomData.players.sente.name 
            });
        }

        function listenToRoom() {
            onlineGame.gameListener = db.collection('rooms').doc(onlineGame.roomPassword)
                .onSnapshot(function(doc) {
                    if (doc.exists) {
                        const roomData = doc.data();
                        handleRoomUpdate(roomData);
                    } else {
                        showStatus('部屋が見つかりません', 'error');
                    }
                }, function(error) {
                    console.error('部屋監視エラー:', error);
                    showStatus('部屋の監視でエラーが発生しました: ' + error.message, 'error');
                });

            onlineGame.isOnline = true;
            gameMode = 'online';
        }

        function handleRoomUpdate(roomData) {
            if (roomData.gameStatus === 'playing' && roomData.players.gote && onlineGame.playerSide === 'sente') {
                document.getElementById('opponent-name').textContent = roomData.players.gote.name;
                showStatus('相手が参加しました。ゲーム開始！', 'success');
            }

            if (roomData.board) {
                sfenToBoard(roomData.board);
            }

            currentPlayer = roomData.currentTurn;
            updateTurnDisplay();
            updateOnlineTurnDisplay(roomData.currentTurn);

            if (roomData.chat && roomData.chat.length > 0) {
                const lastMessage = roomData.chat[roomData.chat.length - 1];
                if (lastMessage.timestamp) {
                    addChatMessage(lastMessage);
                }
            }

            updateOnlineGameStatus(roomData.gameStatus);
        }

        async function sendMoveToOpponent(fromRow, fromCol, toRow, toCol) {
            try {
                const move = {
                    from: { row: fromRow, col: fromCol },
                    to: { row: toRow, col: toCol },
                    player: onlineGame.playerSide,
                    timestamp: Date.now() // serverTimestamp() はarrayUnion内では使用不可
                };

                await db.collection('rooms').doc(onlineGame.roomPassword).update({
                    moves: firebase.firestore.FieldValue.arrayUnion(move),
                    currentTurn: currentPlayer,
                    board: boardToSfen(),
                    lastMoveAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('指し手送信エラー:', error);
                showStatus('指し手の送信に失敗しました', 'error');
            }
        }

        function boardToSfen() {
            return JSON.stringify(board);
        }

        function sfenToBoard(sfen) {
            try {
                const newBoard = JSON.parse(sfen);
                if (JSON.stringify(newBoard) !== JSON.stringify(board)) {
                    board = newBoard;
                    renderBoard();
                }
            } catch (error) {
                console.error('盤面復元エラー:', error);
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || !onlineGame.isOnline) return;

            try {
                const chatMessage = {
                    player: onlineGame.playerSide,
                    playerName: onlineGame.playerName,
                    message: message,
                    timestamp: Date.now() // serverTimestamp() はarrayUnion内では使用不可
                };

                await db.collection('rooms').doc(onlineGame.roomPassword).update({
                    chat: firebase.firestore.FieldValue.arrayUnion(chatMessage)
                });

                input.value = '';
                
            } catch (error) {
                console.error('チャット送信エラー:', error);
                showStatus('メッセージの送信に失敗しました', 'error');
            }
        }

        async function resign() {
            if (!onlineGame.isOnline) return;
            
            if (confirm('本当に投了しますか？')) {
                try {
                    const winner = onlineGame.playerSide === 'sente' ? 'gote' : 'sente';
                    
                    await db.collection('rooms').doc(onlineGame.roomPassword).update({
                        gameStatus: 'finished',
                        result: {
                            winner: winner,
                            loser: onlineGame.playerSide,
                            reason: 'resignation',
                            finishedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    showStatus('投了しました', 'info');
                    
                } catch (error) {
                    console.error('投了エラー:', error);
                    showStatus('投了の処理に失敗しました', 'error');
                }
            }
        }

        function leaveRoom() {
            if (onlineGame.gameListener) {
                onlineGame.gameListener();
                onlineGame.gameListener = null;
            }
            
            onlineGame.isOnline = false;
            gameMode = 'offline';
            
            document.getElementById('join-form').classList.remove('hidden');
            document.getElementById('game-info').classList.add('hidden');
            document.getElementById('online-controls').classList.add('hidden');
            document.getElementById('chat-section').classList.add('hidden');
            
            updateGameStatus('オフライン（ローカル対戦モード）');
            showStatus('部屋を出ました', 'info');
        }

        // UI関数
        function showGameInfo(data) {
            document.getElementById('join-form').classList.add('hidden');
            document.getElementById('game-info').classList.remove('hidden');
            document.getElementById('online-controls').classList.remove('hidden');
            document.getElementById('chat-section').classList.remove('hidden');
            
            document.getElementById('current-room').textContent = onlineGame.roomPassword;
            document.getElementById('your-side').textContent = data.side === 'sente' ? '先手' : '後手';
            
            if (data.opponent) {
                document.getElementById('opponent-name').textContent = data.opponent;
            }
            
            showStatus(data.message, 'success');
        }

        function updateOnlineTurnDisplay(turn) {
            const element = document.getElementById('current-turn-online');
            if (element) {
                element.textContent = turn === 'sente' ? '先手' : '後手';
            }
        }

        function updateOnlineGameStatus(status) {
            if (status === 'playing') {
                updateGameStatus('オンライン対戦中');
            } else if (status === 'waiting') {
                updateGameStatus('相手の参加を待っています...');
            }
        }

        function addChatMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            
            // 重複チェック
            const existingMessages = chatMessages.querySelectorAll('div');
            const messageText = message.playerName + ': ' + message.message;
            for (let i = 0; i < existingMessages.length; i++) {
                if (existingMessages[i].textContent.includes(messageText)) {
                    return; // 既に表示済み
                }
            }
            
            const messageDiv = document.createElement('div');
            // timestampがnumberの場合とFirestoreのTimestampの場合に対応
            const timestamp = message.timestamp;
            let time;
            if (typeof timestamp === 'number') {
                time = new Date(timestamp).toLocaleTimeString();
            } else if (timestamp && timestamp.toDate) {
                time = timestamp.toDate().toLocaleTimeString();
            } else {
                time = new Date().toLocaleTimeString();
            }
            
            messageDiv.innerHTML = 
                '<span style="color: #666; font-size: 10px;">' + time + '</span> ' +
                '<strong style="color: ' + (message.player === 'sente' ? '#8B0000' : '#000080') + ';">' +
                message.playerName + ':</strong> ' +
                message.message;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = 'status-message status-' + type;
            messageDiv.textContent = message;
            
            statusDiv.appendChild(messageDiv);
            
            setTimeout(function() {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // イベントリスナー設定
        document.addEventListener('DOMContentLoaded', function() {
            // 盤面初期化
            initializeBoard();
            updateTurnDisplay();
            
            // イベントリスナー
            document.getElementById('join-room-btn').addEventListener('click', joinRoom);
            document.getElementById('resign-btn').addEventListener('click', resign);
            document.getElementById('leave-room-btn').addEventListener('click', leaveRoom);
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            
            document.getElementById('chat-input').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    sendChatMessage();
                }
            });
        });

    </script>
</body>
</html>
