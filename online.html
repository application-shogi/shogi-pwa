// æ—¢å­˜ã®å°†æ£‹PWAã«è¿½åŠ ã™ã‚‹Firebaseçµ±åˆã‚³ãƒ¼ãƒ‰
// æ—¢å­˜ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®</body>ã®å‰ã«ä»¥ä¸‹ã‚’è¿½åŠ 

// Firebaseè¨­å®šã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚’æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«çµ±åˆ

// 1. Firebase SDKã®èª­ã¿è¾¼ã¿ï¼ˆHTMLã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ ï¼‰
/*
<script type="module">
    // ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’æ—¢å­˜ã®JavaScriptã‚³ãƒ¼ãƒ‰ã®å‰ã«é…ç½®
*/

import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc,
    updateDoc,
    onSnapshot,
    serverTimestamp,
    arrayUnion 
} from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

// Firebaseè¨­å®šï¼ˆã‚ãªãŸã®è¨­å®šæƒ…å ±ï¼‰
const firebaseConfig = {
    apiKey: "AIzaSyBj58MkqswywncKrifsD5RyG68CuqkGQKQ",
    authDomain: "my-shogi-online.firebaseapp.com",
    projectId: "my-shogi-online",
    storageBucket: "my-shogi-online.firebasestorage.app",
    messagingSenderId: "233156650037",
    appId: "1:233156650037:web:14802f4bffe4122a39bd7c",
    measurementId: "G-YLTBF91J1T"
};

let firebaseApp, db;
let isFirebaseReady = false;

// FirebaseåˆæœŸåŒ–
try {
    firebaseApp = initializeApp(firebaseConfig);
    db = getFirestore(firebaseApp);
    isFirebaseReady = true;
    console.log('FirebaseåˆæœŸåŒ–æˆåŠŸ');
} catch (error) {
    console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
}

// 2. æ—¢å­˜ã®å°†æ£‹ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¹ã‚’æ‹¡å¼µã™ã‚‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚¯ãƒ©ã‚¹
class ShogiOnlineExtension {
    constructor(existingGameInstance) {
        this.game = existingGameInstance; // æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‚ç…§
        this.isOnlineMode = false;
        this.roomPassword = null;
        this.playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        this.playerName = null;
        this.playerSide = null;
        this.gameListener = null;
        
        this.setupOnlineUI();
    }

    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã®UIã‚’æ—¢å­˜UIã«è¿½åŠ 
    setupOnlineUI() {
        const onlinePanel = document.createElement('div');
        onlinePanel.id = 'online-panel';
        onlinePanel.innerHTML = `
            <div style="
                position: fixed;
                top: 10px;
                right: 10px;
                width: 300px;
                background: white;
                border: 2px solid #4CAF50;
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                z-index: 1000;
                font-family: Arial, sans-serif;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #4CAF50;">ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</h3>
                    <button id="toggle-online-panel" style="background: none; border: none; font-size: 18px; cursor: pointer;">âœ•</button>
                </div>
                
                <div id="online-join-form">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</label>
                        <input type="text" id="online-player-name" placeholder="ã‚ãªãŸã®åå‰" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ«ãƒ¼ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                        <input type="text" id="online-room-password" placeholder="å‹é”ã¨æ±ºã‚ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <button id="join-online-room" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">éƒ¨å±‹ã«å‚åŠ </button>
                </div>
                
                <div id="online-game-info" style="display: none;">
                    <div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px;">
                        <div><strong>éƒ¨å±‹:</strong> <span id="online-current-room">-</span></div>
                        <div><strong>ã‚ãªãŸ:</strong> <span id="online-your-side">-</span></div>
                        <div><strong>ç›¸æ‰‹:</strong> <span id="online-opponent-name">å¾…æ©Ÿä¸­...</span></div>
                    </div>
                    <button id="leave-online-room" style="width: 100%; padding: 6px; background: #ff9800; color: white; border: none; border-radius: 3px; cursor: pointer;">éƒ¨å±‹ã‚’å‡ºã‚‹</button>
                </div>
                
                <div id="online-status" style="margin-top: 10px; padding: 8px; border-radius: 3px; font-size: 12px; text-align: center;">
                    ã‚ªãƒ•ãƒ©ã‚¤ãƒ³
                </div>
            </div>
        `;
        
        document.body.appendChild(onlinePanel);
        this.bindEvents();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
    bindEvents() {
        document.getElementById('toggle-online-panel').addEventListener('click', () => {
            this.togglePanel();
        });
        
        document.getElementById('join-online-room').addEventListener('click', () => {
            this.joinRoom();
        });
        
        document.getElementById('leave-online-room').addEventListener('click', () => {
            this.leaveRoom();
        });
    }

    togglePanel() {
        const panel = document.getElementById('online-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    // æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ã®æŒ‡ã—æ‰‹å‡¦ç†ã‚’æ‹¡å¼µ
    extendGameMoveFunction() {
        const originalMakeMove = this.game.makeMove.bind(this.game);
        
        this.game.makeMove = (fromRow, fromCol, toRow, toCol) => {
            // æ—¢å­˜ã®æŒ‡ã—æ‰‹å‡¦ç†ã‚’å®Ÿè¡Œ
            const moveResult = originalMakeMove(fromRow, fromCol, toRow, toCol);
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç›¸æ‰‹ã«é€ä¿¡
            if (this.isOnlineMode && this.isMyTurn()) {
                this.sendMoveToOpponent(fromRow, fromCol, toRow, toCol);
            }
            
            return moveResult;
        };
    }

    // éƒ¨å±‹å‚åŠ 
    async joinRoom() {
        if (!isFirebaseReady) {
            this.showStatus('Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
            return;
        }

        const playerName = document.getElementById('online-player-name').value.trim();
        const password = document.getElementById('online-room-password').value.trim();
        
        if (!playerName || !password) {
            this.showStatus('åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            return;
        }

        try {
            this.roomPassword = password;
            this.playerName = playerName;
            
            const roomRef = doc(db, 'rooms', password);
            const roomDoc = await getDoc(roomRef);
            
            if (!roomDoc.exists()) {
                await this.createRoom(password, playerName);
            } else {
                await this.joinExistingRoom(roomDoc.data(), playerName);
            }
            
            this.listenToRoom();
            this.isOnlineMode = true;
            
        } catch (error) {
            console.error('éƒ¨å±‹å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
            this.showStatus('å‚åŠ å¤±æ•—: ' + error.message, 'error');
        }
    }

    async createRoom(password, playerName) {
        this.playerSide = 'sente';
        
        const roomData = {
            password: password,
            players: {
                sente: {
                    id: this.playerId,
                    name: playerName,
                    joinedAt: serverTimestamp()
                },
                gote: null
            },
            board: this.getBoardState(),
            currentTurn: 'sente',
            moves: [],
            gameStatus: 'waiting',
            createdAt: serverTimestamp(),
            chat: []
        };

        await setDoc(doc(db, 'rooms', password), roomData);
        this.showOnlineGameInfo('sente', 'éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    }

    async joinExistingRoom(roomData, playerName) {
        if (roomData.players.gote !== null) {
            throw new Error('ã“ã®éƒ¨å±‹ã¯æ—¢ã«æº€å“¡ã§ã™');
        }
        
        this.playerSide = 'gote';
        
        const roomRef = doc(db, 'rooms', this.roomPassword);
        await updateDoc(roomRef, {
            'players.gote': {
                id: this.playerId,
                name: playerName,
                joinedAt: serverTimestamp()
            },
            gameStatus: 'playing',
            gameStartedAt: serverTimestamp()
        });

        this.showOnlineGameInfo('gote', 'ã‚²ãƒ¼ãƒ é–‹å§‹ï¼');
    }

    listenToRoom() {
        const roomRef = doc(db, 'rooms', this.roomPassword);
        
        this.gameListener = onSnapshot(roomRef, (doc) => {
            if (doc.exists()) {
                const roomData = doc.data();
                this.handleRoomUpdate(roomData);
            }
        });
    }

    handleRoomUpdate(roomData) {
        // ç›¸æ‰‹ã®å‚åŠ æ¤œå‡º
        if (roomData.gameStatus === 'playing' && roomData.players.gote && this.playerSide === 'sente') {
            document.getElementById('online-opponent-name').textContent = roomData.players.gote.name;
            this.showStatus('ç›¸æ‰‹ãŒå‚åŠ ã—ã¾ã—ãŸï¼', 'success');
        }

        // ç›¤é¢åŒæœŸ
        if (roomData.board && roomData.board !== this.getBoardState()) {
            this.syncBoardState(roomData.board);
        }

        // æ‰‹ç•ªåŒæœŸ
        this.game.currentPlayer = roomData.currentTurn;
    }

    async sendMoveToOpponent(fromRow, fromCol, toRow, toCol) {
        try {
            const move = {
                from: { row: fromRow, col: fromCol },
                to: { row: toRow, col: toCol },
                player: this.playerSide,
                timestamp: serverTimestamp()
            };

            const roomRef = doc(db, 'rooms', this.roomPassword);
            await updateDoc(roomRef, {
                moves: arrayUnion(move),
                currentTurn: this.game.currentPlayer,
                board: this.getBoardState(),
                lastMoveAt: serverTimestamp()
            });
            
        } catch (error) {
            console.error('æŒ‡ã—æ‰‹é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // æ—¢å­˜ã‚²ãƒ¼ãƒ ã®ç›¤é¢çŠ¶æ…‹ã‚’å–å¾—
    getBoardState() {
        // æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰ç›¤é¢çŠ¶æ…‹ã‚’å–å¾—
        // ã“ã®éƒ¨åˆ†ã¯æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã«åˆã‚ã›ã¦èª¿æ•´ãŒå¿…è¦
        if (this.game.board) {
            return JSON.stringify(this.game.board);
        }
        return null;
    }

    // ç›¤é¢çŠ¶æ…‹ã‚’æ—¢å­˜ã‚²ãƒ¼ãƒ ã«åæ˜ 
    syncBoardState(boardState) {
        try {
            const board = JSON.parse(boardState);
            if (this.game.board) {
                this.game.board = board;
                if (this.game.renderBoard) {
                    this.game.renderBoard();
                }
            }
        } catch (error) {
            console.error('ç›¤é¢åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    isMyTurn() {
        if (!this.isOnlineMode) return true;
        return (this.game.currentPlayer === 'sente' && this.playerSide === 'sente') ||
               (this.game.currentPlayer === 'gote' && this.playerSide === 'gote');
    }

    leaveRoom() {
        if (this.gameListener) {
            this.gameListener();
            this.gameListener = null;
        }
        
        this.isOnlineMode = false;
        this.roomPassword = null;
        this.playerSide = null;
        
        document.getElementById('online-join-form').style.display = 'block';
        document.getElementById('online-game-info').style.display = 'none';
        
        this.showStatus('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³', 'info');
    }

    showOnlineGameInfo(side, message) {
        document.getElementById('online-join-form').style.display = 'none';
        document.getElementById('online-game-info').style.display = 'block';
        
        document.getElementById('online-current-room').textContent = this.roomPassword;
        document.getElementById('online-your-side').textContent = side === 'sente' ? 'å…ˆæ‰‹' : 'å¾Œæ‰‹';
        
        this.showStatus(message, 'success');
    }

    showStatus(message, type) {
        const statusDiv = document.getElementById('online-status');
        const colors = {
            success: '#4CAF50',
            error: '#f44336',
            info: '#2196F3'
        };
        
        statusDiv.textContent = message;
        statusDiv.style.backgroundColor = colors[type] || '#666';
        statusDiv.style.color = 'white';
    }
}

// 3. æ—¢å­˜ã‚²ãƒ¼ãƒ ã¨ã®çµ±åˆ
// æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸã‚‰ä»¥ä¸‹ã‚’å®Ÿè¡Œ

/*
ä½¿ç”¨ä¾‹:
// æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—
const existingGame = window.shogiGame || yourExistingGameInstance;

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚’æ‹¡å¼µ
const onlineExtension = new ShogiOnlineExtension(existingGame);

// æ—¢å­˜ã®æŒ‡ã—æ‰‹å‡¦ç†ã‚’æ‹¡å¼µ
onlineExtension.extendGameMoveFunction();

console.log('å°†æ£‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
*/
