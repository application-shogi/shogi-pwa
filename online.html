// 既存の将棋PWAに追加するFirebase統合コード
// 既存のHTMLファイルの</body>の前に以下を追加

// Firebase設定とオンライン機能を既存コードに統合

// 1. Firebase SDKの読み込み（HTMLのヘッダーに追加）
/*
<script type="module">
    // 以下のコードを既存のJavaScriptコードの前に配置
*/

import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc,
    updateDoc,
    onSnapshot,
    serverTimestamp,
    arrayUnion 
} from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

// Firebase設定（あなたの設定情報）
const firebaseConfig = {
    apiKey: "AIzaSyBj58MkqswywncKrifsD5RyG68CuqkGQKQ",
    authDomain: "my-shogi-online.firebaseapp.com",
    projectId: "my-shogi-online",
    storageBucket: "my-shogi-online.firebasestorage.app",
    messagingSenderId: "233156650037",
    appId: "1:233156650037:web:14802f4bffe4122a39bd7c",
    measurementId: "G-YLTBF91J1T"
};

let firebaseApp, db;
let isFirebaseReady = false;

// Firebase初期化
try {
    firebaseApp = initializeApp(firebaseConfig);
    db = getFirestore(firebaseApp);
    isFirebaseReady = true;
    console.log('Firebase初期化成功');
} catch (error) {
    console.error('Firebase初期化エラー:', error);
}

// 2. 既存の将棋ゲームクラスを拡張するオンライン機能クラス
class ShogiOnlineExtension {
    constructor(existingGameInstance) {
        this.game = existingGameInstance; // 既存のゲームインスタンスを参照
        this.isOnlineMode = false;
        this.roomPassword = null;
        this.playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        this.playerName = null;
        this.playerSide = null;
        this.gameListener = null;
        
        this.setupOnlineUI();
    }

    // オンライン機能のUIを既存UIに追加
    setupOnlineUI() {
        const onlinePanel = document.createElement('div');
        onlinePanel.id = 'online-panel';
        onlinePanel.innerHTML = `
            <div style="
                position: fixed;
                top: 10px;
                right: 10px;
                width: 300px;
                background: white;
                border: 2px solid #4CAF50;
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                z-index: 1000;
                font-family: Arial, sans-serif;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #4CAF50;">🌐 オンライン対戦</h3>
                    <button id="toggle-online-panel" style="background: none; border: none; font-size: 18px; cursor: pointer;">✕</button>
                </div>
                
                <div id="online-join-form">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">プレイヤー名:</label>
                        <input type="text" id="online-player-name" placeholder="あなたの名前" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ルームパスワード:</label>
                        <input type="text" id="online-room-password" placeholder="友達と決めたパスワード" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <button id="join-online-room" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">部屋に参加</button>
                </div>
                
                <div id="online-game-info" style="display: none;">
                    <div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px;">
                        <div><strong>部屋:</strong> <span id="online-current-room">-</span></div>
                        <div><strong>あなた:</strong> <span id="online-your-side">-</span></div>
                        <div><strong>相手:</strong> <span id="online-opponent-name">待機中...</span></div>
                    </div>
                    <button id="leave-online-room" style="width: 100%; padding: 6px; background: #ff9800; color: white; border: none; border-radius: 3px; cursor: pointer;">部屋を出る</button>
                </div>
                
                <div id="online-status" style="margin-top: 10px; padding: 8px; border-radius: 3px; font-size: 12px; text-align: center;">
                    オフライン
                </div>
            </div>
        `;
        
        document.body.appendChild(onlinePanel);
        this.bindEvents();
    }

    // イベントバインディング
    bindEvents() {
        document.getElementById('toggle-online-panel').addEventListener('click', () => {
            this.togglePanel();
        });
        
        document.getElementById('join-online-room').addEventListener('click', () => {
            this.joinRoom();
        });
        
        document.getElementById('leave-online-room').addEventListener('click', () => {
            this.leaveRoom();
        });
    }

    togglePanel() {
        const panel = document.getElementById('online-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    // 既存のゲームの指し手処理を拡張
    extendGameMoveFunction() {
        const originalMakeMove = this.game.makeMove.bind(this.game);
        
        this.game.makeMove = (fromRow, fromCol, toRow, toCol) => {
            // 既存の指し手処理を実行
            const moveResult = originalMakeMove(fromRow, fromCol, toRow, toCol);
            
            // オンラインモードの場合、相手に送信
            if (this.isOnlineMode && this.isMyTurn()) {
                this.sendMoveToOpponent(fromRow, fromCol, toRow, toCol);
            }
            
            return moveResult;
        };
    }

    // 部屋参加
    async joinRoom() {
        if (!isFirebaseReady) {
            this.showStatus('Firebase接続エラー', 'error');
            return;
        }

        const playerName = document.getElementById('online-player-name').value.trim();
        const password = document.getElementById('online-room-password').value.trim();
        
        if (!playerName || !password) {
            this.showStatus('名前とパスワードを入力してください', 'error');
            return;
        }

        try {
            this.roomPassword = password;
            this.playerName = playerName;
            
            const roomRef = doc(db, 'rooms', password);
            const roomDoc = await getDoc(roomRef);
            
            if (!roomDoc.exists()) {
                await this.createRoom(password, playerName);
            } else {
                await this.joinExistingRoom(roomDoc.data(), playerName);
            }
            
            this.listenToRoom();
            this.isOnlineMode = true;
            
        } catch (error) {
            console.error('部屋参加エラー:', error);
            this.showStatus('参加失敗: ' + error.message, 'error');
        }
    }

    async createRoom(password, playerName) {
        this.playerSide = 'sente';
        
        const roomData = {
            password: password,
            players: {
                sente: {
                    id: this.playerId,
                    name: playerName,
                    joinedAt: serverTimestamp()
                },
                gote: null
            },
            board: this.getBoardState(),
            currentTurn: 'sente',
            moves: [],
            gameStatus: 'waiting',
            createdAt: serverTimestamp(),
            chat: []
        };

        await setDoc(doc(db, 'rooms', password), roomData);
        this.showOnlineGameInfo('sente', '部屋を作成しました。相手を待っています...');
    }

    async joinExistingRoom(roomData, playerName) {
        if (roomData.players.gote !== null) {
            throw new Error('この部屋は既に満員です');
        }
        
        this.playerSide = 'gote';
        
        const roomRef = doc(db, 'rooms', this.roomPassword);
        await updateDoc(roomRef, {
            'players.gote': {
                id: this.playerId,
                name: playerName,
                joinedAt: serverTimestamp()
            },
            gameStatus: 'playing',
            gameStartedAt: serverTimestamp()
        });

        this.showOnlineGameInfo('gote', 'ゲーム開始！');
    }

    listenToRoom() {
        const roomRef = doc(db, 'rooms', this.roomPassword);
        
        this.gameListener = onSnapshot(roomRef, (doc) => {
            if (doc.exists()) {
                const roomData = doc.data();
                this.handleRoomUpdate(roomData);
            }
        });
    }

    handleRoomUpdate(roomData) {
        // 相手の参加検出
        if (roomData.gameStatus === 'playing' && roomData.players.gote && this.playerSide === 'sente') {
            document.getElementById('online-opponent-name').textContent = roomData.players.gote.name;
            this.showStatus('相手が参加しました！', 'success');
        }

        // 盤面同期
        if (roomData.board && roomData.board !== this.getBoardState()) {
            this.syncBoardState(roomData.board);
        }

        // 手番同期
        this.game.currentPlayer = roomData.currentTurn;
    }

    async sendMoveToOpponent(fromRow, fromCol, toRow, toCol) {
        try {
            const move = {
                from: { row: fromRow, col: fromCol },
                to: { row: toRow, col: toCol },
                player: this.playerSide,
                timestamp: serverTimestamp()
            };

            const roomRef = doc(db, 'rooms', this.roomPassword);
            await updateDoc(roomRef, {
                moves: arrayUnion(move),
                currentTurn: this.game.currentPlayer,
                board: this.getBoardState(),
                lastMoveAt: serverTimestamp()
            });
            
        } catch (error) {
            console.error('指し手送信エラー:', error);
        }
    }

    // 既存ゲームの盤面状態を取得
    getBoardState() {
        // 既存のゲームインスタンスから盤面状態を取得
        // この部分は既存コードの構造に合わせて調整が必要
        if (this.game.board) {
            return JSON.stringify(this.game.board);
        }
        return null;
    }

    // 盤面状態を既存ゲームに反映
    syncBoardState(boardState) {
        try {
            const board = JSON.parse(boardState);
            if (this.game.board) {
                this.game.board = board;
                if (this.game.renderBoard) {
                    this.game.renderBoard();
                }
            }
        } catch (error) {
            console.error('盤面同期エラー:', error);
        }
    }

    isMyTurn() {
        if (!this.isOnlineMode) return true;
        return (this.game.currentPlayer === 'sente' && this.playerSide === 'sente') ||
               (this.game.currentPlayer === 'gote' && this.playerSide === 'gote');
    }

    leaveRoom() {
        if (this.gameListener) {
            this.gameListener();
            this.gameListener = null;
        }
        
        this.isOnlineMode = false;
        this.roomPassword = null;
        this.playerSide = null;
        
        document.getElementById('online-join-form').style.display = 'block';
        document.getElementById('online-game-info').style.display = 'none';
        
        this.showStatus('オフライン', 'info');
    }

    showOnlineGameInfo(side, message) {
        document.getElementById('online-join-form').style.display = 'none';
        document.getElementById('online-game-info').style.display = 'block';
        
        document.getElementById('online-current-room').textContent = this.roomPassword;
        document.getElementById('online-your-side').textContent = side === 'sente' ? '先手' : '後手';
        
        this.showStatus(message, 'success');
    }

    showStatus(message, type) {
        const statusDiv = document.getElementById('online-status');
        const colors = {
            success: '#4CAF50',
            error: '#f44336',
            info: '#2196F3'
        };
        
        statusDiv.textContent = message;
        statusDiv.style.backgroundColor = colors[type] || '#666';
        statusDiv.style.color = 'white';
    }
}

// 3. 既存ゲームとの統合
// 既存のゲームインスタンスが利用可能になったら以下を実行

/*
使用例:
// 既存のゲームクラスのインスタンスを取得
const existingGame = window.shogiGame || yourExistingGameInstance;

// オンライン機能を拡張
const onlineExtension = new ShogiOnlineExtension(existingGame);

// 既存の指し手処理を拡張
onlineExtension.extendGameMoveFunction();

console.log('将棋オンライン機能が追加されました！');
*/
